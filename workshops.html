import pandas as pd
import firebase_admin
from firebase_admin import credentials, firestore
from datetime import datetime

# ğŸ”¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase
cred = credentials.Certificate("serviceAccountKey.json")
firebase_admin.initialize_app(cred)
db = firestore.client()

# ğŸ”¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³Ù„
file_path = "ÙˆØ±Ø´ Ø¹Ù…Ù„ Ù…Ø­Ø§ÙˆØ± ÙˆÙ…ÙˆØ§Ø¹ÙŠØ¯.xlsx"
sheets = ["17 NOV 2025", "18 NOV 2025", "19 NOV 2025"]

# ğŸ”¹ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
for doc in db.collection("workshops").stream():
    doc.reference.delete()

def read_workshops(sheet_name):
    df = pd.read_excel(file_path, sheet_name=sheet_name)
    df.columns = df.columns.str.strip()  

    print(f"\nğŸ“Œ Sheet: {sheet_name}")
    print("Available columns:", list(df.columns))  # ğŸŸ¢ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚

    # Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
    title_col = "title" if "title" in df.columns else "Unnamed: 1"
    topic_col = "topic" if "topic" in df.columns else "Unnamed: 2"
    date_col  = "date"  if "date" in df.columns else "Ø§Ù„ÙŠÙˆÙ…"
    time_col  = "time"  if "time" in df.columns else "Ø§Ù„ÙˆÙ‚Øª"

    workshops = []
    current = None

    for _, row in df.iterrows():
        if pd.notna(row[title_col]):  # Ø¨Ø¯Ø§ÙŠØ© ÙˆØ±Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø©
            if current:
                workshops.append(current)

            # âœ… Ø§Ù„ØªØ§Ø±ÙŠØ®
            date_value = None
            if date_col in df.columns and pd.notna(row[date_col]):
                try:
                    date_value = pd.to_datetime(row[date_col], dayfirst=True, errors="coerce")
                except:
                    date_value = None

            # âœ… Ø§Ù„ÙˆÙ‚Øª
            time_value = ""
            if time_col in df.columns and pd.notna(row[time_col]):
                time_value = str(row[time_col]).strip()

            current = {
                "title": str(row[title_col]).strip(),
                "date": date_value,
                "time": time_value,
                "topics": [],
                "reserved": False
            }

        # âœ… Ø§Ù„Ù…Ø­Ø§ÙˆØ±
        if pd.notna(row[topic_col]) and current:
            current["topics"].append(str(row[topic_col]).strip())

    if current:
        workshops.append(current)

    return workshops

# ğŸ”¹ Ø¯Ù…Ø¬ ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚
all_workshops = []
for sheet in sheets:
    workshops = read_workshops(sheet)
    all_workshops.extend(workshops)

# ğŸ”¹ Ø±ÙØ¹ Ø¹Ù„Ù‰ Firestore
for i, w in enumerate(all_workshops, start=1):
    db.collection("workshops").document(str(i)).set(w)

print(f"âœ… ØªÙ… Ø±ÙØ¹/ØªØ­Ø¯ÙŠØ« {len(all_workshops)} ÙˆØ±Ø´Ø© Ø¥Ù„Ù‰ Firestore Ø¨Ù†Ø¬Ø§Ø­")
input("Ø§Ø¶ØºØ· Enter Ù„Ù„Ø®Ø±ÙˆØ¬...")
