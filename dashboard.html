<!-- Firebase + إدارة الورش -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getFirestore, collection, doc, updateDoc, onSnapshot, getDoc, getDocs } 
    from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCC5Wea1ccPTVNo8nfe2fSv7s6JIKulXTc",
    authDomain: "reservation-system-492d6.firebaseapp.com",
    projectId: "reservation-system-492d6",
    storageBucket: "reservation-system-492d6.appspot.com",
    messagingSenderId: "982147661254",
    appId: "1:982147661254:web:47606a698bd01b5b0746c7",
    measurementId: "G-J3BQB3M68D"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const workshopsRef = collection(db, "workshops");
  let workshopsData = [];

  // 📊 عرض الورش والعدادات
  onSnapshot(workshopsRef, (snapshot) => {
    workshopsData = [];
    const tbody = document.getElementById('workshops');
    tbody.innerHTML = "";

    let total = snapshot.size;
    let reserved = 0;
    let unreserved = 0;
    let i = 1;

    snapshot.forEach((docSnap) => {
      const data = docSnap.data();
      const hasTrainer = data.reservedBy && Object.keys(data.reservedBy).length > 0;
      if (hasTrainer) reserved++; else unreserved++;

      // جمع المتقدمين
      let participants = [];
      if (Array.isArray(data.requests)) participants = [...data.requests];
      if (hasTrainer) participants.push({ ...data.reservedBy, confirmed: true });

      workshopsData.push({
        id: docSnap.id,
        title: data.title,
        date: data.date,
        time: data.time,
        participants,
        reservedBy: data.reservedBy || {}
      });

      // إنشاء صف واحد لكل ورشة
      const row = document.createElement('tr');
      const participantsHTML = participants.length
        ? participants.map((p, idx) => `
          <div style="margin-bottom:5px; padding:4px; border-radius:6px; background:${p.confirmed ? '#d4edda' : '#f0f0f0'};">
            <strong>${p.name || ''}</strong> <br>
            <small>${p.email || ''}</small> <br>
            ${p.confirmed 
              ? `<button class="action delete-btn" onclick="cancelApproval('${docSnap.id}')">❌ إلغاء</button>`
              : `<button class="action approve-btn" onclick="approveTrainer('${docSnap.id}', ${idx})">✅ تأكيد</button>`}
          </div>
        `).join('')
        : `<span style="color:#999;">لا يوجد متقدمين بعد</span>`;

      row.innerHTML = `
        <td>${i}</td>
        <td>${data.title || ''}</td>
        <td>${data.date || ''}</td>
        <td>${data.time || ''}</td>
        <td>${hasTrainer ? '<span class="reserved">محجوز</span>' : '<span class="available">شاغر</span>'}</td>
        <td>${participants.length}</td>
        <td>${participantsHTML}</td>
      `;
      tbody.appendChild(row);
      i++;
    });

    document.getElementById("totalCount").textContent = total;
    document.getElementById("reservedCount").textContent = reserved;
    document.getElementById("unreservedCount").textContent = unreserved;
  });

  // ✅ تأكيد المدرب (مع الحماية من التكرار)
  window.approveTrainer = async function (workshopId, participantIndex) {
    const workshopRef = doc(db, "workshops", workshopId);
    let workshopSnap = await getDoc(workshopRef);

    if (!workshopSnap.exists()) {
      await new Promise(r => setTimeout(r, 800));
      workshopSnap = await getDoc(workshopRef);
    }
    if (!workshopSnap.exists()) return showPopup("❌ لم يتم العثور على الورشة.", "error");

    const data = workshopSnap.data();
    const requests = Array.isArray(data.requests) ? [...data.requests] : [];
    const selected = requests[participantIndex];
    if (!selected) return showPopup("⚠️ لم يتم العثور على بيانات المتقدم.", "warn");

    // تحقق من التكرار في ورش أخرى
    const snapshot = await getDocs(collection(db, "workshops"));
    let duplicateWorkshop = null;
    snapshot.forEach((docSnap) => {
      const d = docSnap.data();
      if (
        d.reservedBy &&
        d.reservedBy.email &&
        selected.email &&
        d.reservedBy.email.toLowerCase() === selected.email.toLowerCase() &&
        docSnap.id !== workshopId
      ) {
        duplicateWorkshop = d.title || "ورشة أخرى";
      }
    });

    if (duplicateWorkshop) {
      showPopup(`⚠️ لا يمكن تأكيد ${selected.name || "المدرب"} لأنه مؤكد مسبقًا في "${duplicateWorkshop}".`, "warn");
      return;
    }

    if (data.reservedBy && Object.keys(data.reservedBy).length > 0) {
      const existingName = data.reservedBy.name || "مدرب آخر";
      showPopup(`⚠️ تم بالفعل تأكيد (${existingName}) لهذه الورشة.`, "warn");
      return;
    }

    await updateDoc(workshopRef, { reservedBy: selected });
    requests.splice(participantIndex, 1);
    await updateDoc(workshopRef, { requests });
    showPopup(`✅ تم تأكيد ${selected.name || "المدرب"} لهذه الورشة بنجاح.`, "success");
  };

  // ❌ إلغاء التأكيد
  window.cancelApproval = async function (workshopId) {
    const workshopRef = doc(db, "workshops", workshopId);
    const workshopSnap = await getDoc(workshopRef);
    if (!workshopSnap.exists()) return showPopup("❌ لم يتم العثور على الورشة.", "error");

    const data = workshopSnap.data();
    const reservedBy = data.reservedBy || {};
    if (!Object.keys(reservedBy).length) return showPopup("⚠️ لا يوجد مدرب مؤكد.", "warn");

    const requests = Array.isArray(data.requests) ? [...data.requests, reservedBy] : [reservedBy];
    await updateDoc(workshopRef, { reservedBy: {}, requests });
    showPopup(`🚫 تم إلغاء تأكيد ${reservedBy.name || "المدرب"}.`, "info");
  };

  // 💬 نافذة منبثقة أنيقة
  function showPopup(message, type = "info") {
    const colors = {
      success: "#28a745",
      error: "#dc3545",
      warn: "#ffc107",
      info: "#007bff"
    };
    const popup = document.createElement("div");
    popup.textContent = message;
    popup.style.cssText = `
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: ${colors[type] || "#333"}; color: #fff; padding: 12px 25px;
      border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 9999; font-size: 14px; text-align: center; opacity: 0; transition: opacity 0.3s ease;
    `;
    document.body.appendChild(popup);
    setTimeout(() => popup.style.opacity = "1", 100);
    setTimeout(() => {
      popup.style.opacity = "0";
      setTimeout(() => popup.remove(), 400);
    }, 3000);
  }
</script>
