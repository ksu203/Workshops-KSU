<script type="module">
window.addEventListener("DOMContentLoaded", () => {
  import("https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js").then(({ initializeApp }) => {
    import("https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js").then(({ getFirestore, collection, doc, updateDoc, onSnapshot, getDoc }) => {
      
      const firebaseConfig = {
        apiKey: "AIzaSyCC5Wea1ccPTVNo8nfe2fSv7s6JIKulXTc",
        authDomain: "reservation-system-492d6.firebaseapp.com",
        projectId: "reservation-system-492d6",
        storageBucket: "reservation-system-492d6.appspot.com",
        messagingSenderId: "982147661254",
        appId: "1:982147661254:web:47606a698bd01b5b0746c7",
        measurementId: "G-J3BQB3M68D"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const workshopsRef = collection(db, "workshops");
      let workshopsData = [];

      // 🔹 الفلتر
      window.applyFilter = function () {
        const filter = document.getElementById("filterSelect").value;
        const tbody = document.getElementById("workshops");
        if (!tbody) return; // 🔒 حماية إضافية
        tbody.innerHTML = "";

        let filtered = [...workshopsData];

        if (filter === "most") {
          const maxCount = Math.max(...filtered.map(w => w.participants.length));
          filtered = filtered.filter(w => w.participants.length === maxCount);
        } else if (filter === "more3") {
          filtered = filtered.filter(w => w.participants.length > 3);
        } else if (filter === "less3") {
          filtered = filtered.filter(w => w.participants.length <= 3);
        }

        renderTable(filtered);
      };

      // 🔹 عرض البيانات
      onSnapshot(workshopsRef, (snapshot) => {
        workshopsData = [];
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          let participants = [];
          if (Array.isArray(data.requests)) participants = [...participants, ...data.requests];
          if (data.reservedBy && Object.keys(data.reservedBy).length > 0) participants.push(data.reservedBy);

          workshopsData.push({
            id: docSnap.id,
            title: data.title || '',
            date: data.date || '',
            time: data.time || '',
            participants,
            bookingClosed: data.bookingClosed || false,
            reservedBy: data.reservedBy || {}
          });
        });

        renderTable(workshopsData);
      });

      // 🔹 إنشاء الجدول
      function renderTable(dataList) {
        const tbody = document.getElementById("workshops");
        if (!tbody) return; // 🔒 حماية إضافية
        tbody.innerHTML = "";
        let i = 1, total = 0, reserved = 0, unreserved = 0;

        dataList.forEach((data) => {
          total++;
          const participants = data.participants || [];

          let statusHTML = "";
          if (data.bookingClosed) statusHTML = `<span class="reserved" style="color:#b30000;font-weight:bold;">الحجز مغلق 🚫</span>`;
          else if (Object.keys(data.reservedBy || {}).length > 0) {
            statusHTML = `<span class="reserved">محجوز ❌</span>`;
            reserved++;
          } else {
            statusHTML = `<span class="available">متاح ✅</span>`;
            unreserved++;
          }

          if (participants.length > 0) {
            participants.forEach((p, idx) => {
              const reservedAt = p.timestamp ? 
                (p.timestamp.toDate ? p.timestamp.toDate().toLocaleString("ar-EG") : new Date(p.timestamp).toLocaleString("ar-EG")) : "";
              const isConfirmed = (data.reservedBy && data.reservedBy.email === p.email);

              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${i}</td>
                <td>${data.title}</td>
                <td>${data.date}</td>
                <td>${data.time}</td>
                <td>${statusHTML}</td>
                <td>${participants.length}</td>
                <td>${p.name || ""}</td>
                <td>${p.email || ""}</td>
                <td>${p.phone || ""}</td>
                <td>${p.organization || ""}</td>
                <td><button class="action about-btn" onclick="showAbout('${p.name}','${p.city||''}','${p.organization||''}','${p.about||''}')">👁️ عرض</button></td>
                <td>${reservedAt}</td>
                <td>
                  ${isConfirmed 
                    ? `<button class="action delete-btn" onclick="cancelApproval('${data.id}')">❌ إلغاء التأكيد</button>` 
                    : `<button class="action approve-btn" onclick="approveTrainer('${data.id}', ${idx})">✅ تأكيد</button>`
                  }
                  <button class="action delete-btn" onclick="deleteParticipant('${data.id}', ${idx})">🗑️ حذف</button>
                </td>
              `;
              tbody.appendChild(row);
              i++;
            });
          } else {
            const row = document.createElement("tr");
            row.style.backgroundColor = "#f5f5f5";
            row.innerHTML = `
              <td>${i}</td>
              <td>${data.title}</td>
              <td>${data.date}</td>
              <td>${data.time}</td>
              <td>${statusHTML}</td>
              <td>0</td>
              <td colspan="7">لا يوجد متقدمين بعد</td>
            `;
            tbody.appendChild(row);
            i++;
          }
        });

        document.getElementById("totalCount").textContent = total;
        document.getElementById("reservedCount").textContent = reserved;
        document.getElementById("unreservedCount").textContent = unreserved;
      }

      // 🗑️ حذف مشارك
      window.deleteParticipant = async function(workshopId, participantIndex) {
        const workshopRef = doc(db, "workshops", workshopId);
        const workshopSnap = await getDoc(workshopRef);
        if (workshopSnap.exists()) {
          const data = workshopSnap.data();
          const requests = Array.isArray(data.requests) ? [...data.requests] : [];
          if (participantIndex >= requests.length && data.reservedBy) await updateDoc(workshopRef, { reservedBy: {} });
          else { requests.splice(participantIndex, 1); await updateDoc(workshopRef, { requests }); }
          alert("✅ تم حذف المشارك بنجاح.");
        }
      };

      // ✅ تأكيد المدرب
      window.approveTrainer = async function (workshopId, participantIndex) {
        const workshopRef = doc(db, "workshops", workshopId);
        const workshopSnap = await getDoc(workshopRef);

        if (!workshopSnap.exists()) return alert("❌ لم يتم العثور على الورشة.");

        const data = workshopSnap.data();
        const requests = Array.isArray(data.requests) ? [...data.requests] : [];
        const confirmedTrainer = data.reservedBy && Object.keys(data.reservedBy).length > 0;

        // إذا كان فيه مدرب مؤكد مسبقًا
        if (confirmedTrainer) {
          const existingName = data.reservedBy.name || "مدرب آخر";
          alert(`⚠️ لا يمكن تأكيد أكثر من مدرب لهذه الورشة.\nتم تأكيد ${existingName} مسبقًا.`);
          return;
        }

        // الحصول على المتقدم المحدد
        const selected = requests[participantIndex];
        if (!selected) return alert("❌ لم يتم العثور على بيانات المتقدم.");

        // تأكيده كمدرب أساسي
        await updateDoc(workshopRef, { reservedBy: selected });

        // إزالة المتقدم من قائمة الطلبات
        requests.splice(participantIndex, 1);
        await updateDoc(workshopRef, { requests });

        alert(`✅ تم تأكيد ${selected.name || "المتقدم"} كمدرب لهذه الورشة بنجاح.`);
      };

      // 🔁 إلغاء التأكيد
      window.cancelApproval = async function (workshopId) {
        const workshopRef = doc(db, "workshops", workshopId);
        const workshopSnap = await getDoc(workshopRef);
        if (!workshopSnap.exists()) return alert("❌ لم يتم العثور على الورشة.");

        const data = workshopSnap.data();
        const reservedBy = data.reservedBy || {};

        if (Object.keys(reservedBy).length === 0)
          return alert("⚠️ لا يوجد مدرب مؤكد لإلغائه.");

        // إرجاع المدرب لقائمة المتقدمين
        const requests = Array.isArray(data.requests) ? [...data.requests, reservedBy] : [reservedBy];
        await updateDoc(workshopRef, { reservedBy: {}, requests });
        alert(`🚫 تم إلغاء تأكيد ${reservedBy.name || "المدرب"} وإعادته إلى قائمة المتقدمين.`);
      };

      // 👁️ عرض النبذة
      window.showAbout = function(name, city, org, about) {
        document.getElementById("modalName").textContent = name;
        document.getElementById("modalCity").textContent = city;
        document.getElementById("modalOrg").textContent = org;
        document.getElementById("modalAbout").textContent = about;
        document.getElementById("aboutModal").style.display = "block";
      };
      window.closeModal = function() { document.getElementById("aboutModal").style.display = "none"; };

    });
  });
});
</script>
