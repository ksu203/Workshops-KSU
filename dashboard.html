<script type="module">
window.addEventListener("DOMContentLoaded", () => {
  import("https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js").then(({ initializeApp }) => {
    import("https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js").then(({ getFirestore, collection, doc, updateDoc, onSnapshot, getDoc }) => {
      
      const firebaseConfig = {
        apiKey: "AIzaSyCC5Wea1ccPTVNo8nfe2fSv7s6JIKulXTc",
        authDomain: "reservation-system-492d6.firebaseapp.com",
        projectId: "reservation-system-492d6",
        storageBucket: "reservation-system-492d6.appspot.com",
        messagingSenderId: "982147661254",
        appId: "1:982147661254:web:47606a698bd01b5b0746c7",
        measurementId: "G-J3BQB3M68D"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const workshopsRef = collection(db, "workshops");
      let workshopsData = [];

      // ğŸ”¹ Ø§Ù„ÙÙ„ØªØ±
      window.applyFilter = function () {
        const filter = document.getElementById("filterSelect").value;
        const tbody = document.getElementById("workshops");
        if (!tbody) return; // ğŸ”’ Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©
        tbody.innerHTML = "";

        let filtered = [...workshopsData];

        if (filter === "most") {
          const maxCount = Math.max(...filtered.map(w => w.participants.length));
          filtered = filtered.filter(w => w.participants.length === maxCount);
        } else if (filter === "more3") {
          filtered = filtered.filter(w => w.participants.length > 3);
        } else if (filter === "less3") {
          filtered = filtered.filter(w => w.participants.length <= 3);
        }

        renderTable(filtered);
      };

      // ğŸ”¹ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      onSnapshot(workshopsRef, (snapshot) => {
        workshopsData = [];
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          let participants = [];
          if (Array.isArray(data.requests)) participants = [...participants, ...data.requests];
          if (data.reservedBy && Object.keys(data.reservedBy).length > 0) participants.push(data.reservedBy);

          workshopsData.push({
            id: docSnap.id,
            title: data.title || '',
            date: data.date || '',
            time: data.time || '',
            participants,
            bookingClosed: data.bookingClosed || false,
            reservedBy: data.reservedBy || {}
          });
        });

        renderTable(workshopsData);
      });

      // ğŸ”¹ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      function renderTable(dataList) {
        const tbody = document.getElementById("workshops");
        if (!tbody) return; // ğŸ”’ Ø­Ù…Ø§ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©
        tbody.innerHTML = "";
        let i = 1, total = 0, reserved = 0, unreserved = 0;

        dataList.forEach((data) => {
          total++;
          const participants = data.participants || [];

          let statusHTML = "";
          if (data.bookingClosed) statusHTML = `<span class="reserved" style="color:#b30000;font-weight:bold;">Ø§Ù„Ø­Ø¬Ø² Ù…ØºÙ„Ù‚ ğŸš«</span>`;
          else if (Object.keys(data.reservedBy || {}).length > 0) {
            statusHTML = `<span class="reserved">Ù…Ø­Ø¬ÙˆØ² âŒ</span>`;
            reserved++;
          } else {
            statusHTML = `<span class="available">Ù…ØªØ§Ø­ âœ…</span>`;
            unreserved++;
          }

          if (participants.length > 0) {
            participants.forEach((p, idx) => {
              const reservedAt = p.timestamp ? 
                (p.timestamp.toDate ? p.timestamp.toDate().toLocaleString("ar-EG") : new Date(p.timestamp).toLocaleString("ar-EG")) : "";
              const isConfirmed = (data.reservedBy && data.reservedBy.email === p.email);

              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${i}</td>
                <td>${data.title}</td>
                <td>${data.date}</td>
                <td>${data.time}</td>
                <td>${statusHTML}</td>
                <td>${participants.length}</td>
                <td>${p.name || ""}</td>
                <td>${p.email || ""}</td>
                <td>${p.phone || ""}</td>
                <td>${p.organization || ""}</td>
                <td><button class="action about-btn" onclick="showAbout('${p.name}','${p.city||''}','${p.organization||''}','${p.about||''}')">ğŸ‘ï¸ Ø¹Ø±Ø¶</button></td>
                <td>${reservedAt}</td>
                <td>
                  ${isConfirmed 
                    ? `<button class="action delete-btn" onclick="cancelApproval('${data.id}')">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ£ÙƒÙŠØ¯</button>` 
                    : `<button class="action approve-btn" onclick="approveTrainer('${data.id}', ${idx})">âœ… ØªØ£ÙƒÙŠØ¯</button>`
                  }
                  <button class="action delete-btn" onclick="deleteParticipant('${data.id}', ${idx})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </td>
              `;
              tbody.appendChild(row);
              i++;
            });
          } else {
            const row = document.createElement("tr");
            row.style.backgroundColor = "#f5f5f5";
            row.innerHTML = `
              <td>${i}</td>
              <td>${data.title}</td>
              <td>${data.date}</td>
              <td>${data.time}</td>
              <td>${statusHTML}</td>
              <td>0</td>
              <td colspan="7">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªÙ‚Ø¯Ù…ÙŠÙ† Ø¨Ø¹Ø¯</td>
            `;
            tbody.appendChild(row);
            i++;
          }
        });

        document.getElementById("totalCount").textContent = total;
        document.getElementById("reservedCount").textContent = reserved;
        document.getElementById("unreservedCount").textContent = unreserved;
      }

      // ğŸ—‘ï¸ Ø­Ø°Ù Ù…Ø´Ø§Ø±Ùƒ
      window.deleteParticipant = async function(workshopId, participantIndex) {
        const workshopRef = doc(db, "workshops", workshopId);
        const workshopSnap = await getDoc(workshopRef);
        if (workshopSnap.exists()) {
          const data = workshopSnap.data();
          const requests = Array.isArray(data.requests) ? [...data.requests] : [];
          if (participantIndex >= requests.length && data.reservedBy) await updateDoc(workshopRef, { reservedBy: {} });
          else { requests.splice(participantIndex, 1); await updateDoc(workshopRef, { requests }); }
          alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ Ø¨Ù†Ø¬Ø§Ø­.");
        }
      };

      // âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø¯Ø±Ø¨
      window.approveTrainer = async function (workshopId, participantIndex) {
        const workshopRef = doc(db, "workshops", workshopId);
        const workshopSnap = await getDoc(workshopRef);

        if (!workshopSnap.exists()) return alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ±Ø´Ø©.");

        const data = workshopSnap.data();
        const requests = Array.isArray(data.requests) ? [...data.requests] : [];
        const confirmedTrainer = data.reservedBy && Object.keys(data.reservedBy).length > 0;

        // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠÙ‡ Ù…Ø¯Ø±Ø¨ Ù…Ø¤ÙƒØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§
        if (confirmedTrainer) {
          const existingName = data.reservedBy.name || "Ù…Ø¯Ø±Ø¨ Ø¢Ø®Ø±";
          alert(`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ£ÙƒÙŠØ¯ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø¯Ø±Ø¨ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ±Ø´Ø©.\nØªÙ… ØªØ£ÙƒÙŠØ¯ ${existingName} Ù…Ø³Ø¨Ù‚Ù‹Ø§.`);
          return;
        }

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯
        const selected = requests[participantIndex];
        if (!selected) return alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù….");

        // ØªØ£ÙƒÙŠØ¯Ù‡ ÙƒÙ…Ø¯Ø±Ø¨ Ø£Ø³Ø§Ø³ÙŠ
        await updateDoc(workshopRef, { reservedBy: selected });

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        requests.splice(participantIndex, 1);
        await updateDoc(workshopRef, { requests });

        alert(`âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ ${selected.name || "Ø§Ù„Ù…ØªÙ‚Ø¯Ù…"} ÙƒÙ…Ø¯Ø±Ø¨ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ±Ø´Ø© Ø¨Ù†Ø¬Ø§Ø­.`);
      };

      // ğŸ” Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ£ÙƒÙŠØ¯
      window.cancelApproval = async function (workshopId) {
        const workshopRef = doc(db, "workshops", workshopId);
        const workshopSnap = await getDoc(workshopRef);
        if (!workshopSnap.exists()) return alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ±Ø´Ø©.");

        const data = workshopSnap.data();
        const reservedBy = data.reservedBy || {};

        if (Object.keys(reservedBy).length === 0)
          return alert("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¯Ø±Ø¨ Ù…Ø¤ÙƒØ¯ Ù„Ø¥Ù„ØºØ§Ø¦Ù‡.");

        // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø¨ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†
        const requests = Array.isArray(data.requests) ? [...data.requests, reservedBy] : [reservedBy];
        await updateDoc(workshopRef, { reservedBy: {}, requests });
        alert(`ğŸš« ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ£ÙƒÙŠØ¯ ${reservedBy.name || "Ø§Ù„Ù…Ø¯Ø±Ø¨"} ÙˆØ¥Ø¹Ø§Ø¯ØªÙ‡ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†.`);
      };

      // ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø¨Ø°Ø©
      window.showAbout = function(name, city, org, about) {
        document.getElementById("modalName").textContent = name;
        document.getElementById("modalCity").textContent = city;
        document.getElementById("modalOrg").textContent = org;
        document.getElementById("modalAbout").textContent = about;
        document.getElementById("aboutModal").style.display = "block";
      };
      window.closeModal = function() { document.getElementById("aboutModal").style.display = "none"; };

    });
  });
});
</script>
