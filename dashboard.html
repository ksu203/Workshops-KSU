<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>لوحة التحكم - ورش العمل</title>
  <style>
    body {
      font-family: "Tahoma", sans-serif;
      direction: rtl;
      background: #f4f7fb;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background: linear-gradient(90deg, #004080, #0066cc);
      padding: 20px;
      text-align: center;
      color: #fff;
    }
    header h1 { margin: 0; }
    .container {
      max-width: 1250px;
      margin: 30px auto;
      background: #fff;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    h2 {
      color: #004080;
      margin-bottom: 20px;
      text-align: center;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
    }
    table, th, td { border: 1px solid #ddd; }
    th, td {
      padding: 10px;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background: #004080;
      color: #fff;
    }
    .reserved { color: red; font-weight: bold; }
    .available { color: green; font-weight: bold; }
    .export-buttons {
      text-align: center;
      margin-bottom: 15px;
    }
    .export-buttons button {
      background: linear-gradient(90deg,#0066cc,#004080);
      margin: 5px;
      font-size: 14px;
      border-radius: 8px;
      color: #fff;
      border: none;
      padding: 8px 14px;
      cursor: pointer;
    }
    .action-btn {
      padding: 5px 8px;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    .delete-btn {
      background: linear-gradient(90deg,#cc0000,#800000);
    }
    .print-btn {
      background: linear-gradient(90deg,#008000,#006400);
      margin-right: 4px;
    }
  </style>
</head>
<body>

<header>
  <h1>لوحة التحكم - ورش العمل</h1>
</header>

<div class="container">
  <h2>📋 قائمة الورش والمشاركين</h2>

  <div class="export-buttons">
    <button onclick="exportExcel()">📊 تصدير Excel</button>
    <button onclick="exportPDF()">📄 تصدير PDF</button>
  </div>

  <table id="workshopsTable">
    <thead>
      <tr>
        <th>م</th>
        <th>العنوان</th>
        <th>التاريخ</th>
        <th>الوقت</th>
        <th>عدد المتقدمين</th>
        <th>الاسم</th>
        <th>الإيميل</th>
        <th>الجوال</th>
        <th>الجهة</th>
        <th>نبذة</th>
        <th>تاريخ الحجز</th>
        <th>إجراءات</th>
      </tr>
    </thead>
    <tbody id="workshops"></tbody>
  </table>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getFirestore, collection, doc, updateDoc, onSnapshot, getDoc } 
    from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCC5Wea1ccPTVNo8nfe2fSv7s6JIKulXTc",
    authDomain: "reservation-system-492d6.firebaseapp.com",
    projectId: "reservation-system-492d6",
    storageBucket: "reservation-system-492d6.appspot.com",
    messagingSenderId: "982147661254",
    appId: "1:982147661254:web:47606a698bd01b5b0746c7",
    measurementId: "G-J3BQB3M68D"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const workshopsRef = collection(db, "workshops");

  // عرض الورش والمشاركين
  onSnapshot(workshopsRef, (snapshot) => {
    const tbody = document.getElementById('workshops');
    tbody.innerHTML = "";
    let i = 1;
    snapshot.forEach((docSnap) => {
      const data = docSnap.data();
      let participants = [];

      if (Array.isArray(data.requests)) participants = [...participants, ...data.requests];
      if (data.reservedBy && Object.keys(data.reservedBy).length > 0) participants.push(data.reservedBy);

      if (participants.length > 0) {
        participants.forEach((p, idx) => {
          let reservedAt = "";
          if (p.timestamp) {
            const dateObj = p.timestamp.toDate ? p.timestamp.toDate() : new Date(p.timestamp);
            reservedAt = dateObj.toLocaleDateString("ar-EG") + " - " + dateObj.toLocaleTimeString("ar-EG");
          }

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${i}</td>
            <td>${data.title || ''}</td>
            <td>${data.date || ''}</td>
            <td>${data.time || ''}</td>
            <td>${participants.length}</td>
            <td>${p.name || ''}</td>
            <td>${p.email || ''}</td>
            <td>${p.phone || ''}</td>
            <td>${p.organization || ''}</td>
            <td>${p.about || ''}</td>
            <td>${reservedAt || ''}</td>
            <td>
              <button class="print-btn action-btn" onclick='printAgreement(${JSON.stringify(p)}, "${data.title || ''}")'>🖨️ إقرار</button>
              <button class="delete-btn action-btn" onclick="deleteParticipant('${docSnap.id}', ${idx})">🗑️ حذف</button>
            </td>
          `;
          tbody.appendChild(row);
          i++;
        });
      }
    });
  });

  // حذف مشارك
  window.deleteParticipant = async function(workshopId, participantIndex) {
    const workshopRef = doc(db, "workshops", workshopId);
    const workshopSnap = await getDoc(workshopRef);
    if (workshopSnap.exists()) {
      let data = workshopSnap.data();
      let requests = Array.isArray(data.requests) ? [...data.requests] : [];
      if (participantIndex >= requests.length && data.reservedBy) {
        await updateDoc(workshopRef, { reservedBy: {} });
      } else {
        requests.splice(participantIndex, 1);
        await updateDoc(workshopRef, { requests: requests });
      }
      alert("✅ تم حذف المشارك بنجاح.");
    }
  }

  // طباعة الإقرار
  window.printAgreement = function(participant, workshopTitle) {
    const newWin = window.open("");
    const now = new Date().toLocaleString("ar-EG");
    newWin.document.write(`
      <html lang="ar">
      <head>
        <meta charset="UTF-8">
        <title>إقرار المشاركة</title>
        <style>
          body { font-family: 'Tahoma', sans-serif; direction: rtl; padding: 40px; }
          .header { text-align: center; margin-bottom: 25px; }
          img { width: 110px; }
          h2 { color: #004080; }
          .info { border: 1px solid #ccc; padding: 15px; border-radius: 8px; background: #f9f9f9; }
          .info p { margin: 8px 0; }
          .agreement { margin-top: 25px; line-height: 1.8; }
          .footer { text-align: center; margin-top: 35px; font-weight: bold; color: #004080; }
        </style>
      </head>
      <body>
        <div class="header">
          <img src="https://upload.wikimedia.org/wikipedia/commons/2/2f/Hadaf_logo.png" alt="شعار صندوق تنمية الموارد البشرية">
          <h2>إقرار المشاركة في ورشة عمل</h2>
          <h3>📘 ${workshopTitle}</h3>
        </div>

        <div class="info">
          <p><strong>الاسم:</strong> ${participant.name || ''}</p>
          <p><strong>المدينة:</strong> ${participant.city || ''}</p>
          <p><strong>البريد الإلكتروني:</strong> ${participant.email || ''}</p>
          <p><strong>رقم الجوال:</strong> ${participant.phone || ''}</p>
          <p><strong>الجهة:</strong> ${participant.organization || ''}</p>
          <p><strong>نبذة:</strong> ${participant.about || ''}</p>
        </div>

        <div class="agreement">
          <p>
            أقر بأنني قد قرأت جميع التعليمات والتوضيحات الخاصة بإعداد وتقديم ورش العمل في ملتقى الإرشاد المهني،
            وأوافق على الالتزام بها التزامًا تامًا. كما أوافق على تصوير الورشة واستخدام محتواها في أي من المنصات
            الإعلامية الخاصة بالملتقى أو الشركاء المنظمين دون أي التزام مالي أو قانوني تجاه إدارة الملتقى.
          </p>
          <p><strong>تاريخ الإقرار الإلكتروني:</strong> ${now}</p>
        </div>

        <div class="footer">
          تمنياتنا لكم بالتوفيق والسداد<br>صندوق تنمية الموارد البشرية
        </div>
      </body>
      </html>
    `);
    newWin.print();
    newWin.close();
  };
</script>

<!-- مكتبات التصدير -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  // تصدير Excel
  function exportExcel() {
    const table = document.getElementById("workshopsTable");
    const wb = XLSX.utils.table_to_book(table, { sheet: "ورش العمل" });
    XLSX.writeFile(wb, "قائمة_ورش_العمل.xlsx");
  }

  // تصدير PDF
  async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: "landscape" });
    doc.setFont("helvetica", "bold");
    doc.text("📋 تقرير ورش العمل والمشاركين", 150, 15, { align: "center" });
    const table = document.getElementById("workshopsTable");
    let rows = [];
    for (let i = 1; i < table.rows.length; i++) {
      const cells = table.rows[i].cells;
      let rowData = [];
      for (let j = 0; j < cells.length - 1; j++) {
        rowData.push(cells[j].innerText);
      }
      rows.push(rowData);
    }
    let y = 25;
    rows.forEach((r, idx) => {
      doc.text(r.join(" | "), 10, y + (idx * 8));
    });
    doc.save("تقرير_ورش_العمل.pdf");
  }
</script>

</body>
</html>
